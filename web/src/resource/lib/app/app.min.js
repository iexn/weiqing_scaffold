define(function(e,t,n){function i(e,t){if("function"==o(t)&&(t={done:t}),t=k.defaults(t,{before:function(){},done:function(e){return!0},fail:function(){}},t),!1===t.before())return!1;S.post(e,{url:location.href}).then(function(e){var n=e;if(0!=n.errno)return t.fail(n.message,n.data),!1;U.sysinfo=w=n.data,v.config(n.data.account.jssdkconfig),a(function(e){if(!1===e)return document.querySelector("#loading").remove(),!1;t.done(function(e){if(!1===e)return document.querySelector("#loading").remove(),!1;"function"==o(e)&&e(),document.querySelector("#loading").remove(),document.querySelector("#app").style.display="block",document.querySelector("#app").style.visibility="visible",document.querySelector("#app").style.opacity="1"},w)})}).fail(function(e){console.error(e),t.fail(!1)})}function o(e){return"object"!=typeof e?typeof e:Object.prototype.toString.call(e).slice(8,-1).toLowerCase()}function r(){v.hideAllNonBaseMenuItem(),v.showMenuItems({menuList:["menuItem:share:appMessage","menuItem:share:timeline","menuItem:share:brand"]})}function a(e){v.ready(function(){r(),e&&e(!0)}),v.error(function(t){e&&e(!1,t)})}function c(e,t,n,i){var o=w.siteroot+"app/index.php",r=i||o;if(-1!=e.indexOf("/")){var a=e.split("/");t=t||{},e=a[0],t.et=a[1]}var c=k.defaults(t,{i:w.acid,c:"entry",do:e,m:w.module.name});return s(r,c,n)}function s(e,t,n){var i=e||"",o=[];for(var r in t)o.push(r+"="+encodeURI(t[r]));return i+="?"+o.join("&"),void 0!==n&&(i+="#"+n),i}function l(e,t){var n;switch(t=k.defaults(t,{text:!0,type:2}),t.type){case 1:n=["barCode"];break;case 2:n=["qrCode"];break;case 0:default:n=["qrCode","barCode"]}v.ready(function(){v.scanQRCode({needResult:0==t.text?0:1,scanType:n,success:function(t){"scanQRCode:ok"==t.errMsg?e&&e(t.resultStr):console.log("扫码识别错误，请重新尝试")}})})}function u(e){e=k.defaults(e,{fee:"",title:"",sn:"",done:function(){},cancel:function(){},fail:function(){}}),S.post("index.php?i="+w.uniacid+"&j="+w.acid+"&c=entry&m=core&do=pay&iswxapp=0",{method:"wechat",tid:e.sn,title:e.title,fee:e.fee,module:w.module.name}).then(function(t){if("string"==typeof t&&(t=S.parseJSON(t)),0!=t.message.errno)return e.fail(t.message),!1;var n=t.message.message;v.chooseWXPay({timestamp:n.timeStamp,nonceStr:n.nonceStr,package:n.package,signType:n.signType,paySign:n.paySign,success:function(t){e.done()},cancel:function(){e.cancel()},fail:function(){e.fail(!1)}})})}function d(e){x=!0,e=k.defaults(e,{title:"",desc:"",imgUrl:"",link:location.href,done:function(){}}),v.updateAppMessageShareData({title:e.title,desc:e.desc,imgUrl:e.imgUrl,link:e.link,success:function(t){f(e.done,t)}}),v.onMenuShareAppMessage({title:e.title,desc:e.desc,imgUrl:e.imgUrl,link:e.link,success:function(t){f(e.done,t)}})}function f(e,t){x&&e(t),x=!1}function p(e){C=!0,e=k.defaults(e,{title:"",desc:"",imgUrl:"",link:location.href,done:function(){}}),v.updateTimelineShareData({title:e.title,desc:e.desc,imgUrl:e.imgUrl,link:e.link,success:function(t){h(e.done,t)}}),v.onMenuShareTimeline({title:e.title,desc:e.desc,imgUrl:e.imgUrl,link:e.link,success:function(t){h(e.done,t)}})}function h(e,t){C&&e(t),C=!1}function m(e){e=e||"body",e=document.querySelector(e);var t=e.style.position;"relative"!=t&&"absolute"!=t&&"fixed"!=t&&(e.style.position="relative");var n=document.createElement("div");return n.id="loading_loader",n.setAttribute("style","position:absolute;top:0;left:0;width:100%;height:100%;z-index:1"),n.innerHTML='<div style="position:absolute;width:3rem;height:3rem;top:0;bottom:0;left:0;right:0;margin:auto;background-image:url('+w.resource_url+'loading.gif);background-size:contain;background-repeat:no-repeat"></div>',e.appendChild(n),{hide:function(t){e.removeChild(n),t&&t()}}}function o(e){var t=typeof e;return"object"!=t?t:(t=Object.prototype.toString.call(e),t.slice(8,-1).toLowerCase())}function g(e){try{return null===e.offsetParent}catch(e){return!1}}function y(e,t,n){function i(){var e=Math.abs(a.offset().top+a.height()-S(parent.parent).scrollTop()- -r.offset)<window.innerHeight;e&&!s&&(s=!0,a.html('<i class="fas fa-spinner fa-spin"></i> 正在加载中'),r.callback&&r.callback(function(e){e?a.text("没有更多数据了"):(a.text("上拉加载更多"),s=!1)},g(r.parent)))}var r={selector:null,parent:window,callback:function(e){},offset:5};r="object"==o(e)?S.extend({},r,e):S.extend({},r,{selector:e,callback:t,offset:n});var a=S("<p>").addClass("text-center load-more").text("上拉加载更多"),c=S(r.selector),s=!1;return c.append(a),S(r.parent).on("scroll",i),g(S(r.parent)[0])||i(),{run:i}}function b(){this.routes={},this.currentURL=""}var v=e("wx"),k=e("lodash"),S=e("jquery"),w={},U={},x=!0,C=!0;b.prototype.route=function(e,t){this.routes[e]=t||function(){}},b.prototype.refresh=function(){this.currentURL=location.hash.slice(1),this.routes[this.currentURL]?this.routes[this.currentURL]({currentUrl:this.currentURL}):this.routes["/"]({currentUrl:"/"})},b.prototype.init=function(){window.addEventListener("load",this.refresh.bind(this),!1),window.addEventListener("hashchange",this.refresh.bind(this),!1)},t.init=i,t.ready=a,t.wx={scan:l,pay:u,shareMessage:d,shareTimeline:p},t.url=c,t.router=new b,t.loading=m,t.loadmore=y});
define(function(e,t,n){function i(e,t){if("function"==o(t)&&(t={done:t}),t=y.defaults(t,{before:function(){},done:function(e){return!0},fail:function(){}},t),!1===t.before())return!1;v.post(e,{url:location.href}).then(function(e){var n=e;if(0!=n.errno)return t.fail(n.message,n.data),!1;S.sysinfo=b=n.data,g.config(n.data.account.jssdkconfig),r(function(e){if(!1===e)return document.querySelector("#loading").remove(),!1;t.done(function(e){if(!1===e)return document.querySelector("#loading").remove(),!1;"function"==o(e)&&e(),document.querySelector("#loading").remove(),document.querySelector("#app").style.display="block",document.querySelector("#app").style.visibility="visible",document.querySelector("#app").style.opacity="1"},b)})}).fail(function(e){console.error(e),t.fail(!1)})}function o(e){return"object"!=typeof e?typeof e:Object.prototype.toString.call(e).slice(8,-1).toLowerCase()}function r(e){return e&&e(!0),!1}function c(e,t,n,i){var r=b.siteroot+"app/index.php",c=i||r;if(-1!=e.indexOf("/")){var s=e.split("/");e=s[0],t=s[1]}"string"==o(t)&&(t={et:t});var u=y.defaults(t,{i:b.acid,c:"entry",do:e,m:b.module.name});return a(c,u,n)}function a(e,t,n){var i=e||"",o=[];for(var r in t)o.push(r+"="+encodeURI(t[r]));return i+="?"+o.join("&"),void 0!==n&&(i+="#"+n),i}function s(e,t){var n;switch(t=y.defaults(t,{text:!0,type:2}),t.type){case 1:n=["barCode"];break;case 2:n=["qrCode"];break;case 0:default:n=["qrCode","barCode"]}g.ready(function(){g.scanQRCode({needResult:0==t.text?0:1,scanType:n,success:function(t){"scanQRCode:ok"==t.errMsg?e&&e(t.resultStr):console.log("扫码识别错误，请重新尝试")}})})}function u(e){e=y.defaults(e,{fee:"",title:"",sn:"",done:function(){},cancel:function(){},fail:function(){}}),v.post("index.php?i="+b.uniacid+"&j="+b.acid+"&c=entry&m=core&do=pay&iswxapp=0",{method:"wechat",tid:e.sn,title:e.title,fee:e.fee,module:b.module.name}).then(function(t){if("string"==typeof t&&(t=v.parseJSON(t)),0!=t.message.errno)return e.fail(t.message),!1;var n=t.message.message;g.chooseWXPay({timestamp:n.timeStamp,nonceStr:n.nonceStr,package:n.package,signType:n.signType,paySign:n.paySign,success:function(t){e.done()},cancel:function(){e.cancel()},fail:function(){e.fail(!1)}})})}function l(e){U=!0,e=y.defaults(e,{title:"",desc:"",imgUrl:"",link:location.href,done:function(){}}),g.updateAppMessageShareData({title:e.title,desc:e.desc,imgUrl:e.imgUrl,link:location.href,success:function(t){d(e.done,t)}}),g.onMenuShareAppMessage({title:e.title,desc:e.desc,imgUrl:e.imgUrl,link:location.href,success:function(t){d(e.done,t)}})}function d(e,t){U&&e(t),U=!1}function f(e){k=!0,e=y.defaults(e,{title:"",desc:"",imgUrl:"",link:location.href,done:function(){}}),g.updateTimelineShareData({title:e.title,desc:e.desc,imgUrl:e.imgUrl,link:location.href,success:function(t){p(e.done,t)}}),g.onMenuShareTimeline({title:e.title,desc:e.desc,imgUrl:e.imgUrl,link:location.href,success:function(t){p(e.done,t)}})}function p(e,t){k&&e(t),k=!1}function h(e){e=e||"body",e=document.querySelector(e);var t=e.style.position;"relative"!=t&&"absolute"!=t&&"fixed"!=t&&(e.style.position="relative");var n=document.createElement("div");return n.id="loading_loader",n.setAttribute("style","position:absolute;top:0;left:0;width:100%;height:100%;z-index:1"),n.innerHTML='<div style="position:absolute;width:3rem;height:3rem;top:0;bottom:0;left:0;right:0;margin:auto;background-image:url('+b.resource_url+'loading.gif);background-size:contain;background-repeat:no-repeat"></div>',e.appendChild(n),{hide:function(t){e.removeChild(n),t&&t()}}}function m(){this.routes={},this.currentURL=""}var g=e("wx"),y=e("lodash"),v=e("jquery"),b={},S={},U=!0,k=!0;m.prototype.route=function(e,t){this.routes[e]=t||function(){}},m.prototype.refresh=function(){this.currentURL=location.hash.slice(1),this.routes[this.currentURL]?this.routes[this.currentURL]({currentUrl:this.currentURL}):this.routes["/"]({currentUrl:"/"})},m.prototype.init=function(){window.addEventListener("load",this.refresh.bind(this),!1),window.addEventListener("hashchange",this.refresh.bind(this),!1)},t.init=i,t.ready=r,t.wx={scan:s,pay:u,shareMessage:l,shareTimeline:f},t.url=c,t.router=new m,t.loading=h});
define(function(require,e){var i=require("wx"),a=require("weui"),n=require("jquery"),r=require("vue"),s=require("vue-lazyload");r.use(s,{preLoad:1.3,error:"",loading:"data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=",attempt:1});var o=function(t){for(var e=t.split(","),i=e[0].match(/:(.*?);/)[1],a=atob(e[1]),n=a.length,r=new Uint8Array(n);n--;)r[n]=a.charCodeAt(n);return new Blob([r],{type:i})},l=function(t,e,i){var a=new Image;a.src=t,a.onload=function(){var t=this,a=t.width,n=t.height,r=a/n;a=e.width||a,n=e.height||a/r;var s=.7,o=document.createElement("canvas"),l=o.getContext("2d"),u=document.createAttribute("width");u.nodeValue=a;var c=document.createAttribute("height");c.nodeValue=n,o.setAttributeNode(u),o.setAttributeNode(c),l.drawImage(t,0,0,a,n),e.quality&&e.quality<=1&&e.quality>0&&(s=e.quality);var _=o.toDataURL("image/jpeg",s);i(_)}},u=function(t,e,i){var a=new FileReader;a.readAsDataURL(t),a.onload=function(){var t=this.result;l(t,e,i)}},c=function(t,e){location.hash="/";var s=new r({data:{s:"",g:"",cover:"",reward_info:"",amount:"",counsel:"",rule:"",jim:[],gifts:[],unlock:[],uploads:[],gift_score:0,gift_amount:"0",jim_form_text:"",rewardto_users:[],uploads_preview:[],g_preview:e.sysinfo.gets.g||"",support:"",upload_loading:!1,save_loading:!1,appointment_register:!0,show_submit_close_button:!0,ready_upload:!1,my_url:"",account_qrcode_link:"",cav_qrcode_link:"",register_cav_times:0,cav_open:"on",cav_on_give_gift:"0",can_give_gift:!0,is_caver:!1,enter_bless_status:"off",show_call_us:"off",show_caver_register_list:"off",my_qrcode:""},computed:{first_cover:function(){return 0==this.uploads.length?"":this.uploads[0].url}},methods:{picker_date:function(t){var e=t.target;a.datePicker({start:1990,end:2019,onConfirm:function(t){e.value=t[0].value+"-"+t[1].value+"-"+t[2].value}})},submit_register:function(t){var i=this;t.preventDefault();a.confirm("确认提交？",function(){i.$refs.submit_register_btn.disabled=!0,i.$refs.submit_register_btn.innerHTML="<b>报名中...</b>",n.post(e.url("m/register"),n(t.target).serialize()).then(function(t){if(0!=t.errno)return i.$refs.submit_register_btn.disabled=!1,i.$refs.submit_register_btn.innerHTML="<b>立即报名</b>",a.alert(t.message),!1;i.g_preview=t.data.g,i.ready_upload=!0,location.href="#/upload_cover"}).fail(function(){i.$refs.submit_register_btn.disabled=!1,i.$refs.submit_register_btn.innerHTML="<b>立即报名</b>",a.alert("服务器异常，请稍后重试")})})},submit_save_upload:function(t){var i=this;t.preventDefault();var r=a.confirm("确认提交？",function(){i.save_loading=!0;var t=[];i.uploads_preview.map(function(e){t.push(e.path)}),n.post(e.url("m/save_update"),{g:i.g_preview,covers:t}).then(function(t){if(0!=t.errno)return i.save_loading=!1,r.hide(function(){a.alert(t.message)}),!1;a.toast(t.message,{duration:1e3,callback:function(){location.href=t.data.url}})}).fail(function(){i.save_loading=!1,a.alert("服务器异常，请稍后重试")})})},upload:function(t){var i=this,r=t.target;if(""==r.value)return!1;this.upload_loading=!0;var s=new FormData,l=r.files[0],c=function(t){s.append("image",t,"file_"+Date.parse(new Date)+".jpg"),n.ajax({url:e.url("w7/upload_image"),type:"POST",data:s,cache:!1,processData:!1,contentType:!1}).then(function(t){if(i.upload_loading=!1,0!=t.errno)return a.alert(t.message),!1;i.uploads_preview.push({path:t.data.path,url:t.data.url})})};l.size>1048576?u(l,{quality:.2},function(t){var e=o(t);c(e)}):c(l)},remove_upload:function(t){if(!confirm("确定删除这张图片吗？"))return!1;this.uploads_preview.splice(this.uploads_preview.indexOf(t),1)},rewardto_gift:function(t){t.preventDefault();var i=this;this.$refs.fix_appointment_btn.innerHTML="请稍后...",this.$refs.fix_appointment_btn.disabled=!0,n.post(e.url("m/rewardto"),n(t.target).serialize()).then(function(t){if(0!=t.errno)return a.alert(t.message,function(){i.$refs.fix_appointment_btn.innerHTML="赠送礼物",i.$refs.fix_appointment_btn.disabled=!1}),!1;if("pay"==t.data.action)e.wx.pay({fee:t.data.fee,title:t.data.title,sn:t.data.sn,done:function(){a.toast("赠送成功",{duration:1e3,callback:function(){location.reload()}})}}),i.$refs.fix_appointment_btn.innerHTML="赠送礼物",i.$refs.fix_appointment_btn.disabled=!1;else if("tolink_pay"==t.data.action){var n={sn:t.data.sn,result:"wait",time:t.data.time};window.localStorage.setItem("pay",JSON.stringify(n)),location.href=t.data.payment}else"redirect"==t.data.action&&(location.hash="/",a.toast("赠送成功",{duration:1e3,callback:function(){location.reload()}}))}).fail(function(){a.alert("服务器异常，请稍后再试"),this.$refs.fix_appointment_btn.innerHTML="赠送礼物",this.$refs.fix_appointment_btn.disabled=!1})},img2base64:function(t){this.cav_qrcode_link=t.src},init_active:function(t){var a=this;for(var r in n(".layouter-close").on("click",function(){location.hash="/"}),document.title=t.title,this.s=t.s,this.g=e.sysinfo.gets.g||"",this.cover=t.cover,this.reward_info=t.reward_info,this.amount=t.amount,this.counsel=t.counsel,this.rule=t.rule,this.cav_open=t.cav_open,this.cav_on_give_gift=t.cav_on_give_gift,this.enter_bless_status=t.enter_bless_status,this.show_call_us=t.show_call_us,this.show_caver_register_list=t.show_caver_register_list,this.gifts.push(...t.gift),this.unlock.push(...t.unlock),t.jim){var s=t.jim[r];s.value="",this.jim.push(s)}if(t.arrive_time>0)this.$refs.details_countdown_timeout.innerHTML="活动未开始";else if(t.out_time<0)this.$refs.details_countdown_timeout.innerHTML="活动结束";else var o=setInterval(function(){var e=t.out_time;if(e<=0)return a.$refs.details_countdown_timeout.innerHTML="活动结束",clearInterval(o),!1;var i=e%60;e-=i;var n=e%3600/60,r=Math.floor(e/3600),s=r+"时"+n+"分"+i+"秒";a.$refs.details_countdown_timeout.innerHTML="活动倒计时："+s,t.out_time-=1},1e3);i.ready(function(){var e=document.createElement("audio");e.loop=!0,e.volume=1,e.src=t.music,n(".fix-music").on("click",function(){e.paused?(n(this).addClass("on"),e.play()):(n(this).removeClass("on"),e.pause())}),WeixinJSBridge.invoke("getNetworkType",{},function(t){n(".fix-music").trigger("click")},!1)}),this.$refs.rank_link.href=e.url("p/rank",{s:this.s,g:this.g}),n(".input-inc button").on("click",function(){var t=~~n(this).attr("data-step"),e=~~n(".input-inc input").val()+t;e<1&&(e=1),n(".input-inc input").val(e)})},init_share:function(t){if("object"!=typeof t)return!1;var i={title:t.title,desc:t.desc,imgUrl:t.imgUrl,link:t.link,done:function(){n.get(t.done_url)}};e.wx.shareMessage(i),e.wx.shareTimeline(i)},init_register:function(t){if(this.gift_score=t.gift_score||0,this.gift_amount=t.gift_amount||0,this.jim_form_text=t.jim_form_text||"",this.cav_qrcode_link=t.cav_qrcode_link||"",this.register_cav_times=t.cav_times||0,t.jim)for(var i in this.jim.length=0,t.jim){var a=t.jim[i];a.placeholder="",this.jim.push(a)}this.uploads.push(...t.covers),t.openid==e.sysinfo.openid&&this.uploads_preview.push(...t.covers)},init_others:function(){this.support=e.sysinfo.config.support},export_register:function(){location.href=e.url("p/export_register",{s:this.s})},bless_animate:function(t){t?(setTimeout(function(){n(".enter-bless").addClass("enter-bless-on")},500),n(".fix-bless-mask").on("click",function(){n(".enter-bless").removeClass("enter-bless-on"),setTimeout(function(){n(".enter-bless").addClass("enter-bless-state")},300),setTimeout(function(){n(".enter-bless-state").addClass("enter-bless-state-on")},500)})):n(".enter-bless").addClass("enter-bless-state enter-bless-state-on")}},filters:{encodeUnicode:function(t){for(var e=[],i=0;i<t.length;i++)e[i]=("00"+t.charCodeAt(i).toString(16)).slice(-4);return"\\u"+e.join("\\u")},decodeUnicode:function(t){return t=t.replace(/\\/g,"%"),unescape(t)},amount_text:function(t){return 0==t?"免费":"￥"+t}}});n.post(e.url("m/detail"),{s:e.sysinfo.gets.s,g:e.sysinfo.gets.g}).then(function(i){if(6!=i.errno){if(i.data.register&&e.sysinfo.openid!=i.data.register.openid?s.appointment_register=!0:s.appointment_register=!1,"on"==i.data.active.cav_open&&i.data.active.cav_on_give_gift>0?s.can_give_gift=!1:s.can_give_gift=!0,s.my_url=i.data.my_url,s.$mount("#app"),e.router.route("/",function(){n(".fix-layouter").removeClass("on")}),n(".fix-layouter[data-layout-router-name]").each(function(a,r){var o=n(this).attr("data-layout-router-name"),l=this;e.router.route(o,function(){"/appointment_over"==o&&s.appointment_register?location.href="#/appointment":"/gift"!=o||"preview"!=i.data.action?("/appointment"==o&&""!=i.data.my_url&&"openid"in i.data.register&&i.data.register.openid!=e.sysinfo.openid&&(location.href="#/redirect_my"),"/redirect_my"==o&&""==i.data.my_url&&(location.href="#/appointment"),"/appointment"==o&&s.ready_upload&&(location.href="#/upload_cover"),"/export"==o&&(1==i.data.is_caver?n.post(e.url("m/getRank"),{s:e.sysinfo.gets.s}).then(function(e){var i="";if(e.data.length>0)for(var a in e.data){var n=e.data[a];i+='<tr><td class="text-center"><td><div class="avatar" data-src="'+n.avatar+'" style="background-image:url(data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=)"></div></td><td>'+n.name+'</td><td>赞个数:<span class="lighthigh">'+n.gift_score+'</span></td><td>已收到:<span class="lighthigh">￥'+n.gift_amount+"</span></td><td>"+n.cav_status_name+"</td></tr>"}else i+='<tr><td class="text-center" colspan="5" style="line-height:8rem">暂无数据</td></tr>';document.querySelector(".rank-list").innerHTML=i,t()}).fail(function(){t(!1)}):location.href="#/"),n(".fix-layouter").removeClass("on"),n(l).addClass("on")):location.href="#/appointment"})}),e.router.init(),0!=i.errno){var r=i.data.action,o=i.data.active,l=i.data.register;switch(r){case"preview":s.init_active(o),s.init_share(i.data.share),s.init_register(l),s.init_others(),s.account_qrcode_link=i.data.account_qrcode_link||"",s.bless_animate("highlight"==s.enter_bless_status),s.is_caver=i.data.is_caver||!1,t();break;case"register":s.init_active(o),s.appointment_register=!0,t(),location.href="#/appointment";break;case"upload_cover":s.s=o.s,s.g=e.sysinfo.gets.g||"",s.show_submit_close_button=!1,t(),location.href="#/upload_cover";break;default:t(!1),a.alert(i.message,function(){history.back()})}return window.$vm=s,!1}o=i.data.active,l=i.data.register;var u=i.data.rewardto_users;s.init_active(o),s.init_share(i.data.share),s.init_register(l),s.init_others(),s.account_qrcode_link=i.data.account_qrcode_link||"",s.my_qrcode=i.data.my_qrcode||"",s.is_caver=i.data.is_caver||!1,"is_first_view"in i.data.register&&"true"==i.data.register.is_first_view&&"on"==s.show_call_us&&(location.href="#/call-us"),s.appointment_register||(s.$refs.appointment_link.href="#/menu",s.$refs.appointment_name.innerHTML="我的预约"),s.rewardto_users.push(...u),s.bless_animate("highlight"==s.enter_bless_status),"on"!=s.show_call_us&&n(".fix-call-us").remove(),"on"!=s.show_caver_register_list&&n(".fix-export").remove(),t()}else location.replace(i.data.url)}).fail(function(){alert("页面读取失败，请重试"),t(!1)})};e.run=c});